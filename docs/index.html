<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curve Blockhash Oracle Status</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        h1 {
            font-size: 24px;
            font-weight: 500;
        }

        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover { background: #5558e3; }
        button:disabled { background: #444; cursor: not-allowed; }
        button.yellow { background: #f59e0b; }
        button.yellow:hover { background: #d97706; }

        .notice {
            background: #f59e0b20;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        .chains-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 8px;
        }

        .chain-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 16px;
            transition: all 0.2s;
            animation: fadeIn 0.3s ease-out;
        }

        .chain-card:hover {
            border-color: #555;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chain-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .chain-name {
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chain-id {
            font-size: 14px;
            color: #888;
        }

        .chain-info {
            display: grid;
            gap: 6px;
            font-size: 14px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            color: #888;
        }

        .info-value {
            font-family: monospace;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .block-number {
            background: #333;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .time-ago {
            font-size: 12px;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #888;
        }

        .error {
            background: #ef444420;
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .yellow-text {
            color: #f59e0b !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .destination-list {
            margin: 15px 0;
        }

        .destination-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: #2a2a2a;
            border-radius: 6px;
            font-size: 13px;
        }

        .destination-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            flex: 1;
        }

        .destination-cost {
            color: #888;
            font-family: monospace;
            font-size: 12px;
        }

        .modal-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-cost {
            font-size: 14px;
            color: #fff;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        input[type="checkbox"] {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Blockhash Oracle Status</h1>
            <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
        </header>

        <div class="notice">
            <p>⚠️ This is a read-only GitHub Pages version. Write functionality requires running locally with proper CORS headers.</p>
            <p>For full functionality, clone the repository and run <code>python -m http.server</code> from the project root.</p>
        </div>

        <div id="content">
            <div class="loading">Loading deployment data...</div>
        </div>
    </div>

    <div id="broadcastModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Broadcast Destinations</h3>
                <button class="modal-close" onclick="closeBroadcastModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // GitHub raw content base URL
        const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/curvefi/blockhash-oracle/main';

        // Override deployment URLs for GitHub
        const DEPLOYMENT_URL = `${GITHUB_RAW_BASE}/scripts/deployment/deployment_state.json`;
        const CHAINS_URL = `${GITHUB_RAW_BASE}/scripts/chain-parse/chains.json`;

        let provider = null;
        let signer = null;
        let deployments = {};
        let chainData = {};
        let lzMetadata = {};
        let peerEidsCache = {};
        let mainnetBlockCache = { number: null, timestamp: null };

        async function loadDeployments() {
            try {
                const [deploymentsRes, chainsRes] = await Promise.all([
                    fetch(DEPLOYMENT_URL),
                    fetch(CHAINS_URL)
                ]);

                if (!deploymentsRes.ok || !chainsRes.ok) {
                    throw new Error('Failed to load deployment data');
                }

                deployments = await deploymentsRes.json();
                const chainsArray = await chainsRes.json();

                // Convert chains array to object by chainId
                chainData = {};
                chainsArray.forEach(chain => {
                    chainData[chain.chainId] = chain;
                });

                // Try to load LZ metadata
                try {
                    const metadataRes = await fetch(`${GITHUB_RAW_BASE}/scripts/deployment/lz_metadata.json`);
                    if (metadataRes.ok) {
                        lzMetadata = await metadataRes.json();
                    }
                } catch (e) {
                    console.log('LZ metadata not available');
                }

                displayChains();
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h3>Error loading deployment data</h3>
                        <p>${error.message}</p>
                        <p>This viewer requires deployment data to be available in the repository.</p>
                    </div>
                `;
            }
        }

        function displayChains() {
            const chainCards = Object.entries(deployments)
                .filter(([chainId, data]) => data.oracle_address && chainId !== '1')
                .map(([chainId]) => {
                    const chain = chainData[chainId] || { chainId, name: `Chain ${chainId}` };
                    return `
                        <div class="chain-card" data-chain-id="${chainId}">
                            <div class="chain-header">
                                <div class="chain-name">
                                    <span>${chain.name}</span>
                                    <span class="chain-id">(${chainId})</span>
                                </div>
                                <div class="actions" id="actions-${chainId}">
                                    <button onclick="refreshChain('${chainId}')" title="Refresh">↻</button>
                                </div>
                            </div>
                            <div class="chain-info" id="info-${chainId}">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            document.getElementById('content').innerHTML = `
                <div class="chains-grid">${chainCards}</div>
            `;

            // Load data for all chains in parallel
            Object.keys(deployments).forEach(chainId => {
                if (deployments[chainId].oracle_address && chainId !== '1') {
                    loadChainData(chainId);
                }
            });
        }

        async function loadChainData(chainId) {
            const deployment = deployments[chainId];
            const chain = chainData[chainId] || { chainId, rpc: [] };

            if (!chain.rpc || chain.rpc.length === 0) {
                updateChainInfo(chainId, { error: 'No RPC endpoint available' });
                return;
            }

            try {
                // Show initial state
                updateChainInfo(chainId, {
                    oracle: deployment.oracle_address,
                    loading: true
                });

                const rpcUrl = chain.rpc[0];
                const provider = new ethers.providers.JsonRpcProvider(rpcUrl);

                // Simplified read-only display
                const oracle = new ethers.Contract(deployment.oracle_address, [
                    'function last_confirmed_block() view returns (uint256)',
                    'function last_confirmed_header() view returns (bytes32, bytes32, bytes32, bytes32, uint256, uint256)'
                ], provider);

                const [lastBlock, lastHeader] = await Promise.all([
                    oracle.last_confirmed_block(),
                    oracle.last_confirmed_header().catch(() => null)
                ]);

                const lastBlockNumber = lastBlock.toNumber();
                let lastHeaderBlock = 0;

                if (lastHeader && lastHeader[4]) {
                    lastHeaderBlock = lastHeader[4].toNumber();
                }

                updateChainInfo(chainId, {
                    oracle: deployment.oracle_address,
                    lastBlock: lastBlockNumber,
                    lastHeader: lastHeaderBlock,
                    loading: false
                });

            } catch (error) {
                console.error(`Error loading chain ${chainId}:`, error);
                updateChainInfo(chainId, {
                    oracle: deployment.oracle_address,
                    error: error.message
                });
            }
        }

        function updateChainInfo(chainId, data) {
            const infoDiv = document.getElementById(`info-${chainId}`);
            if (!infoDiv) return;

            if (data.loading) {
                infoDiv.innerHTML = '<div class="loading">Loading...</div>';
                return;
            }

            if (data.error) {
                infoDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            const isHeaderOutdated = data.lastHeader < data.lastBlock;

            infoDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Oracle:</span>
                    <span class="info-value">${data.oracle.slice(0, 6)}...${data.oracle.slice(-4)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Block:</span>
                    <span class="info-value">
                        <span class="block-number">${data.lastBlock.toLocaleString()}</span>
                        <span class="time-ago">${calculateTimeAgo(data.lastBlock)}</span>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Header:</span>
                    <span class="info-value">
                        <span class="block-number ${isHeaderOutdated ? 'yellow-text' : ''}">${data.lastHeader.toLocaleString()}</span>
                        <span class="time-ago">${calculateTimeAgo(data.lastHeader)}</span>
                    </span>
                </div>
            `;
        }

        function calculateTimeAgo(blockNumber) {
            if (!mainnetBlockCache.number) return '';

            const blockDiff = mainnetBlockCache.number - blockNumber;
            const secondsAgo = blockDiff * 12;

            if (secondsAgo < 60) return `${Math.floor(secondsAgo)}s ago`;
            if (secondsAgo < 3600) return `${Math.floor(secondsAgo / 60)}m ago`;
            if (secondsAgo < 86400) return `${Math.floor(secondsAgo / 3600)}h ago`;

            const days = Math.floor(secondsAgo / 86400);
            const hours = Math.floor((secondsAgo % 86400) / 3600);
            return `${days}d${hours}h ago`;
        }

        async function refreshChain(chainId) {
            const btn = document.querySelector(`#actions-${chainId} button`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⟳';
            }

            await loadChainData(chainId);

            if (btn) {
                btn.disabled = false;
                btn.textContent = '↻';
            }
        }

        async function connectWallet() {
            // Just show connected state for demo
            document.getElementById('connectWallet').textContent = 'Connected (Read Only)';
            document.getElementById('connectWallet').disabled = true;
        }

        function closeBroadcastModal() {
            document.getElementById('broadcastModal').classList.remove('active');
        }

        // Get mainnet block on load for time calculations
        async function getMainnetBlock() {
            try {
                const response = await fetch('https://api.etherscan.io/api?module=proxy&action=eth_blockNumber');
                const data = await response.json();
                if (data.result) {
                    mainnetBlockCache.number = parseInt(data.result, 16);
                    mainnetBlockCache.timestamp = Date.now();
                }
            } catch (e) {
                // Use a reasonable default
                mainnetBlockCache.number = 18500000;
                mainnetBlockCache.timestamp = Date.now();
            }
        }

        // Initialize
        getMainnetBlock();
        loadDeployments();
    </script>
</body>
</html>
