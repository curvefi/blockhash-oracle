<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curve Blockhash Oracle Status</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        h1 {
            font-size: 24px;
            font-weight: 500;
        }

        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover { background: #5558e3; }
        button:disabled { background: #444; cursor: not-allowed; }

        .broadcast-btn {
            background: #10b981;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        .broadcast-btn:hover { background: #0ea968; }
        .broadcast-btn:disabled { background: #444; }

        .main-block {
            text-align: center;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .main-block .number {
            font-size: 28px;
            font-weight: bold;
            color: #6366f1;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .chain {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px 15px;
            transition: transform 0.2s, border-color 0.2s;
        }

        .chain:hover {
            transform: translateY(-1px);
            border-color: #444;
        }

        .chain-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: capitalize;
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            background: #10b981;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .action-btn:hover { background: #0ea968; }
        .action-btn:disabled { background: #444; }

        .submit-header-btn {
            background: #3b82f6;
        }

        .submit-header-btn:hover { background: #2563eb; }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 13px;
            align-items: baseline;
        }

        .label { color: #888; font-size: 12px; }
        .value { font-family: monospace; font-size: 12px; text-align: right; }
        .time { color: #f59e0b; font-size: 11px; }
        .error { color: #ef4444; font-size: 12px; }
        .loading { color: #888; font-style: italic; font-size: 12px; }
        .outdated { color: #f59e0b; }

        .wallet-info {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }

        .wallet-info.connected { display: block; }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1a1a1a;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .close {
            color: #888;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover { color: #fff; }

        .peer-list {
            margin: 10px 0;
        }

        .peer-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .flip-all-btn {
            background: #444;
            padding: 5px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
        }

        .flip-all-btn:hover { background: #555; }

        .peer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            margin: 3px 0;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
        }

        .peer-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .peer-cost {
            color: #10b981;
            font-family: monospace;
            font-size: 12px;
        }

        .total-cost {
            margin-top: 15px;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 8px 16px;
            font-size: 13px;
        }

        .notice {
            background: #f59e0b20;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Blockhash Oracle Status</h1>
            <div style="display: flex; gap: 10px;">
                <button id="connect-btn" onclick="connectWallet()">Connect Wallet</button>
                <button id="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
        </header>

        <div class="notice">
            <p>⚠️ This is a read-only GitHub Pages version. Write functionality is disabled.</p>
            <p>For full functionality, clone the repository and run locally.</p>
        </div>

        <div class="main-block">
            <div>Ethereum Mainnet</div>
            <div class="number" id="main-block">-</div>
        </div>

        <div class="grid" id="chains-grid"></div>
    </div>

    <div class="status" id="status"></div>
    <div class="wallet-info" id="wallet-info"></div>

    <div class="modal" id="peerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Broadcast Destinations</h2>
                <span class="close" onclick="closePeerModal()">&times;</span>
            </div>
            <div class="peer-list" id="peerList"></div>
            <div class="total-cost">
                <span>Total Cost:</span>
                <span id="totalCost" class="peer-cost">0 ETH</span>
            </div>
            <div class="modal-buttons">
                <button onclick="closePeerModal()">Cancel</button>
                <button id="confirmBroadcast" onclick="proceedWithBroadcast()">Confirm Broadcast</button>
            </div>
        </div>
    </div>

    <script>
        // GitHub Pages URLs
        const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/curvefi/blockhash-oracle/main';
        const DEPLOYMENT_URL = `${GITHUB_RAW_BASE}/scripts/deployment/deployment_state.json`;
        const CHAINS_URL = `${GITHUB_RAW_BASE}/scripts/chain-parse/chains.json`;
        const TIMEOUT = 10000;

        const ORACLE_ABI = [
            "function last_confirmed_block_number() view returns (uint256)",
            "function block_header(uint256) view returns (bytes32, bytes32, bytes32, bytes32, uint256, uint256)",
            "function last_confirmed_header() view returns (bytes32, bytes32, bytes32, bytes32, uint256, uint256)"
        ];

        const RELAY_ABI = [
            "function quote_read_fee(uint128 gas, uint128 value) view returns (uint256)",
            "function quote_broadcast_fees(uint32[] eids, uint128 gas) view returns (uint256[])",
            "function request_block_hash(uint32[] receive_eids, uint256[] amounts, uint128 gas, uint128 read_gas) payable",
            "function peers(uint32) view returns (bytes32)",
            "function read_enabled() view returns (bool)",
            "function mainnet_eid() view returns (uint32)"
        ];

        const HEADER_VERIFIER_ABI = [
            "function submit_block_header(address oracle, bytes header) returns (bool)"
        ];

        let deployments = null;
        let chains = null;
        let lzMetadata = null;
        let mainBlock = 0;
        let provider = null;
        let signer = null;
        let walletConnected = false;
        const peerCache = {}; // Cache peer EIDs per chain
        let currentBroadcastData = null; // Store broadcast data for modal

        async function init() {
            try {
                setStatus('Loading...');

                // Load config files
                const [depResp, chainsResp, lzResp] = await Promise.all([
                    fetch(DEPLOYMENT_URL),
                    fetch(CHAINS_URL),
                    fetch('https://metadata.layerzero-api.com/v1/metadata/deployments')
                ]);

                const depData = await depResp.json();
                const chainsData = await chainsResp.json();
                lzMetadata = await lzResp.json();

                deployments = depData.deployments.mainnets || {};
                chains = chainsData.mainnets || {};

                await refreshData();
            } catch (error) {
                console.error('Init error:', error);
                setStatus('Failed to load', true);
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            setStatus('Updating...');

            try {
                // Clear and create all chain cards immediately
                const grid = document.getElementById('chains-grid');
                grid.innerHTML = '';

                const chainList = Object.entries(deployments)
                    .filter(([name, contracts]) => name !== 'ethereum' && contracts.BlockOracle)
                    .sort(([a], [b]) => a.localeCompare(b));

                // Create cards with loading state
                const cards = {};
                chainList.forEach(([chainName]) => {
                    const card = createChainCard(chainName, { loading: true });
                    cards[chainName] = card;
                    grid.appendChild(card);
                });

                // Get Ethereum block first (needed for age calculation)
                // Only fetch if we don't have it or it's been more than 1 minute
                const now = Date.now();
                if (chains.ethereum?.public && (!mainBlock || now - window.lastMainBlockFetch > 60000)) {
                    try {
                        const provider = new ethers.providers.JsonRpcProvider(chains.ethereum.public);
                        mainBlock = await withTimeout(provider.getBlockNumber(), TIMEOUT);
                        window.lastMainBlockFetch = now;
                        document.getElementById('main-block').textContent = mainBlock.toLocaleString();
                    } catch (error) {
                        document.getElementById('main-block').textContent = 'Error';
                    }
                }

                // Fetch all chain data in parallel and update cards as results come in
                chainList.forEach(async ([chainName, contracts]) => {
                    try {
                        const data = await fetchChainData(chainName, contracts);
                        updateChainCard(cards[chainName], chainName, data);
                    } catch (error) {
                        updateChainCard(cards[chainName], chainName, { error: 'Failed' });
                    }
                });

                setStatus(`Updated at ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                console.error('Refresh error:', error);
                setStatus('Update failed', true);
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchChainData(chainName, contracts) {
            const chainConfig = chains[chainName];
            if (!chainConfig?.public) {
                return { error: 'No RPC' };
            }

            try {
                const provider = new ethers.providers.JsonRpcProvider(chainConfig.public);
                const oracle = new ethers.Contract(contracts.BlockOracle, ORACLE_ABI, provider);

                const lastBlockNum = await withTimeout(oracle.last_confirmed_block_number(), TIMEOUT);
                const lastBlock = lastBlockNum.toNumber();

                let lastHeaderBlock = 0;
                let readEnabled = false;

                // Get last confirmed header directly from the contract
                try {
                    const lastHeader = await withTimeout(oracle.last_confirmed_header(), 5000);
                    // The function returns a tuple: (hash, parentHash, stateRoot, receiptsRoot, blockNumber, timestamp)
                    // Block number is at index 4
                    if (lastHeader && lastHeader[4]) {
                        lastHeaderBlock = lastHeader[4].toNumber();
                    }
                } catch (error) {
                    console.log(`Error getting last header for ${chainName}:`, error);
                    // Fallback: check if latest block has header
                    try {
                        const header = await withTimeout(oracle.block_header(lastBlock), 2000);
                        if (header[1] !== '0x0000000000000000000000000000000000000000000000000000000000000000') {
                            lastHeaderBlock = lastBlock;
                        }
                    } catch {}
                }

                // Check if read enabled
                if (contracts.LZBlockRelay) {
                    try {
                        const relay = new ethers.Contract(contracts.LZBlockRelay, RELAY_ABI, provider);
                        readEnabled = await withTimeout(relay.read_enabled(), 2000);
                    } catch {}
                }

                return { lastBlock, lastHeaderBlock, readEnabled };
            } catch (error) {
                if (error.message === 'Timeout') {
                    return { error: 'Timeout' };
                }
                return { error: 'Error' };
            }
        }

        function createChainCard(chainName, data) {
            const card = document.createElement('div');
            card.className = 'chain';
            card.id = `chain-${chainName}`;

            let blockHtml = '<span class="loading">Loading...</span>';
            let headerHtml = '<span class="loading">Loading...</span>';

            if (data && !data.loading) {
                if (data.error) {
                    blockHtml = `<span class="error">${data.error}</span>`;
                    headerHtml = `<span class="error">${data.error}</span>`;
                } else {
                    if (data.lastBlock) {
                        const blockAge = calculateAge(data.lastBlock);
                        blockHtml = `${data.lastBlock.toLocaleString()} <span class="time">(${blockAge})</span>`;
                    }

                    if (data.lastHeaderBlock) {
                        const headerAge = calculateAge(data.lastHeaderBlock);
                        const isOutdated = data.lastHeaderBlock < data.lastBlock;
                        headerHtml = `<span class="${isOutdated ? 'outdated' : ''}">${data.lastHeaderBlock.toLocaleString()}</span> <span class="time">(${headerAge})</span>`;
                    } else {
                        headerHtml = '<span class="error">None</span>';
                    }
                }
            }

            // GitHub Pages version - no action buttons
            card.innerHTML = `
                <div class="chain-header">
                    <div class="chain-name">${chainName}</div>
                    <div class="action-buttons"></div>
                </div>
                <div class="info-row">
                    <span class="label">Hash:</span>
                    <span class="value" id="${chainName}-block">${blockHtml}</span>
                </div>
                <div class="info-row">
                    <span class="label">Header:</span>
                    <span class="value" id="${chainName}-header">${headerHtml}</span>
                </div>
            `;

            return card;
        }

        function updateChainCard(card, chainName, data) {
            let blockHtml = '<span class="loading">Loading...</span>';
            let headerHtml = '<span class="loading">Loading...</span>';

            if (data.error) {
                blockHtml = `<span class="error">${data.error}</span>`;
                headerHtml = `<span class="error">${data.error}</span>`;
            } else {
                if (data.lastBlock) {
                    const blockAge = calculateAge(data.lastBlock);
                    blockHtml = `${data.lastBlock.toLocaleString()} <span class="time">(${blockAge})</span>`;
                }

                if (data.lastHeaderBlock) {
                    const headerAge = calculateAge(data.lastHeaderBlock);
                    const isOutdated = data.lastHeaderBlock < data.lastBlock;
                    headerHtml = `<span class="${isOutdated ? 'outdated' : ''}">${data.lastHeaderBlock.toLocaleString()}</span> <span class="time">(${headerAge})</span>`;
                } else {
                    headerHtml = '<span class="error">None</span>';
                }
            }

            document.getElementById(`${chainName}-block`).innerHTML = blockHtml;
            document.getElementById(`${chainName}-header`).innerHTML = headerHtml;
        }

        function calculateAge(blockNumber) {
            if (!mainBlock || blockNumber <= 0) return '';

            const blocksBehind = mainBlock - blockNumber;
            const seconds = blocksBehind * 12;

            if (seconds < 60) return `${Math.round(seconds)}s ago`;
            if (seconds < 3600) return `${Math.round(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.round(seconds / 3600)}h ago`;

            const days = Math.floor(seconds / 86400);
            const hours = Math.round((seconds % 86400) / 3600);
            return `${days}d${hours}h ago`;
        }

        function withTimeout(promise, ms) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
            ]);
        }

        function setStatus(text, isError = false) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.style.color = isError ? '#ef4444' : '#888';
        }

        // Connect wallet (disabled for GitHub Pages)
        async function connectWallet() {
            alert('Wallet connection is disabled in the GitHub Pages version. Please run locally for write functionality.');
        }

        // Start on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
